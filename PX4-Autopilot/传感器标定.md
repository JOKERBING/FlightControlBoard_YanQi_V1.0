# 传感器标定

标定是将仪器输出与已知参考信息进行比较，并确定系数的过程，这些系数迫使输出在一定范围内与参考信息一致。

<div align=center><img src="https://jokerbin.oss-cn-beijing.aliyuncs.com/202209041340776.png" width="1000"/></div>

## 陀螺仪校准

代码位置：Firmware/src/modules/commander/gyro_calibration

<div align=center><img src="https://jokerbin.oss-cn-beijing.aliyuncs.com/202209041341564.png" width="500"/></div>

陀螺仪是一种可以测量系统的旋转角速度的传感器，与加速度计类似的，具有x、y、z这3个轴的角速度。从理论上讲，陀螺仪是由多组可以按任意方向旋转的转动装置所组成。转动轴不受外部系统的转动影响，根据角动量守恒原则，转动装置在旋转时会保持恒定的大小和方向。当外部系统发声旋转时内部转动装置仍然保持恒定的方向和速度旋转，测量这两个系统的差就可以得到当前系统的旋转角速度。为了测量x、y、z这3个轴的角速度，通常采用万向节构成转动装置。

陀螺仪校准仍是使用零偏和标度因数来进行校准。但是由于陀螺仪的特殊性标度因数需要使用非常复杂的办法来计算但效果却并不理想，因此在实际应用中并不去处理标度因数，将3轴的标度因数都设定为1，而只去计算3轴的零偏。零偏的计算非常简单，具体方法如下：

1.将陀螺仪静止放置在桌面上，持续记录一段时间的数据。

2.将记录的多组数据求出平均值作为陀螺仪的3轴零偏。

### 陀螺仪动态多速率法标定

陀螺仪的测量模型可写作如下矩阵形式，其中 $\tilde \omega_x$ , $\tilde \omega_y$ , $ \tilde \omega_z$ 为三轴陀螺仪实际输出，$\gamma_{xy}$ , $\gamma_{xz}$ , $\gamma_{yx}$ , $\gamma_{yz}$ , $\gamma_{zx}$ , $\gamma_{zy}$ 为交轴耦合误差分量，$s_x$ , $s_y$ , $s_z$ 为比例因子，$\omega_x$ , $\omega_y$ , $\omega_z$ 为理想陀螺仪输出，$b_{gx}$ , $b_{gy}$ , $b_{gz}$ 为陀螺仪三轴零偏：

$$
\begin{bmatrix}\tilde \omega_x\\ \tilde \omega_y\\ \tilde \omega_z\end{bmatrix}
=
\begin{bmatrix}
s_x & \gamma_{yx} & \gamma_{zx}\\
\gamma_{xy} & s_y & \gamma_{zy}\\
\gamma_{xz} & \gamma_{yz} & s_z
\end{bmatrix}
\begin{bmatrix}
\omega_x\\
\omega_y\\
\omega_z
\end{bmatrix}
+
\begin{bmatrix}
b_{gx}\\
b_{gy}\\
b_{gz}
\end{bmatrix}
=
\begin{bmatrix}
s_x & \gamma_{yx} & \gamma_{zx} & b_{gx}\\
\gamma_{xy} & s_y & \gamma_{zy} & b_{gy}\\
\gamma_{xz} & \gamma_{yz} & s_z & b_{gz}
\end{bmatrix}
\begin{bmatrix}
\omega_x\\
\omega_y\\
\omega_z\\
1
\end{bmatrix}
$$

令

$$
M = \begin{bmatrix}
s_x & \gamma_{yx} & \gamma_{zx} & b_{gx}\\
\gamma_{xy} & s_y & \gamma_{zy} & b_{gy}\\
\gamma_{xz} & \gamma_{yz} & s_z & b_{gz}
\end{bmatrix}
$$

依次让 $x$ , $y$ , $z$ 三轴陀螺仪敏感轴以恒定角速率 $\omega_0$ 正反转，采集六次陀螺仪的输出，得到：

$$
L=\begin{bmatrix} \tilde \omega_{xcw} & \tilde \omega_{xccw} & \tilde \omega_{ycw} & \tilde \omega_{yccw} & \tilde \omega_{zcw} & \tilde \omega_{zccw} \end{bmatrix}
$$

各位置理想陀螺仪输出为：

$$
\omega_{xcw}=\begin{bmatrix} -\omega_0\\ 0\\ 0\end{bmatrix}\quad
\omega_{xccw}=\begin{bmatrix} \omega_0\\ 0\\ 0\end{bmatrix}\quad
\omega_{ycw}=\begin{bmatrix} 0\\ -\omega_0\\ 0\end{bmatrix}\quad
\omega_{yccw}=\begin{bmatrix} 0\\ \omega_0\\ 0\end{bmatrix}\quad
\omega_{zcw}=\begin{bmatrix} 0\\ 0\\ -\omega_0\end{bmatrix}\quad
\omega_{zccw}=\begin{bmatrix} 0\\ 0\\ \omega_0\end{bmatrix}
$$

即：

$$
A=\begin{bmatrix} \omega_{xcw} & \omega_{xccw} & \omega_{ycw} & \omega_{yccw} & \omega_{zcw} & \omega_{zccw}\\1 & 1 & 1 & 1 & 1 & 1 \end{bmatrix}
$$

六位置的陀螺仪输出模型可以写作如下矩阵形式：

$$
\begin{bmatrix} \tilde \omega_{xcw} & \tilde \omega_{xccw} & \tilde \omega_{ycw} & \tilde \omega_{yccw} & \tilde \omega_{zcw} & \tilde \omega_{zccw} \end{bmatrix}
=
M
\begin{bmatrix} \omega_{xcw} & \omega_{xccw} & \omega_{ycw} & \omega_{yccw} & \omega_{zcw} & \omega_{zccw}\\1 & 1 & 1 & 1 & 1 & 1 \end{bmatrix}
$$

$M$矩阵中包含12个待估参数，共有18个方程。可以用最小二乘法求解。

$$
M = LA^T(AA^T)^{-1}
$$

改变恒定角速率 $\omega_0$ 的数值，进行多次实验得到的待估参数取平均即可得到最终结果。

## 磁罗盘校准

代码位置：Firmware/src/modules/commander/mag_calibration

<div align=center><img src="https://jokerbin.oss-cn-beijing.aliyuncs.com/202209041341599.png" width="500"/></div>



## 加速度计校准

代码位置：Firmware/src/modules/commander/accelerometer_calibration

<div align=center><img src="https://jokerbin.oss-cn-beijing.aliyuncs.com/202209041342118.png" width="500"/></div>

加速度计是用于测量当前系统中加速度数值的传感器，可以分别测量x、y、z这3个轴的加速度值，例如MPU6000和MPU9250。其中MPU6000包括3轴加速度计以及3轴陀螺仪，而MPU9250处理包括3轴加速度计以及3轴陀螺仪之外，还含有3轴磁罗盘用于测量3轴的磁场强度。关于陀螺仪和磁罗盘我们在后面讲述，在这里先讨论关于加速度计测量与校准功能。

实际上，加速度计所测量到的加速度值并不是系统的实际加速度，我们可以通过一个原理模型来对3加速度计进行原理说明，假设加速度计测量值就是一个立方体盒子中其6个面对圆球作用力所产生的加速度值。

实际的加速度计并不是由一个封闭的正方体盒子和一个圆球组成的，而是采用微机械结构来实现的加速度测量。3轴加速度计在每一个轴上的测量原理都是一样的，它们测量的并不是实际的运动加速度，而是实际的受力，并除以质量得到加速度测量值。我们可以举一个最简单的例子作为加速度计的设计模型,如下图所示：

加速度计校准的方式采用零偏（offset）和标度因数（scale）。零偏就是传感器的测量值相对于“零点”的偏移量；标度因数可以理解为一个比例系数，测量值乘以这个比例系数之后得到实际值。我们首先来看看零偏的计算方法。

### 加速度计两位置法标定

<div align=center><img src="https://jokerbin.oss-cn-beijing.aliyuncs.com/202209041342450.png" width="600"/></div>


考虑一个静止加速度计的敏感轴分别竖直向上和竖直向下，加速度计所测量到的2个加速度值为：

$$
f_{up} =b+(1+\delta s)g \quad,\quad f_{down} =b-(1+\delta s)g
$$

加速度计的零偏 $b$ 和比例因子 $\delta s$ 可以这样计算：

$$
b=\frac{f_{up}+f_{down}}{2}  \quad,\quad  \delta s=\frac{f_{up}-f_{down}}{2g}-1
$$

假设加速度计的敏感轴有一个倾角 $\theta$ ，则加速度计所测量到的2个加速度值为：

$$
f_{up}^{'} =b+(1+\delta s)gcos\theta \quad,\quad f_{down}^{'}  =b-(1+\delta s)gcos\theta
$$

加速度计的零偏 $b^{'}$ 和比例因子 $\delta s^{'}$ 为：

$$
b^{'}=\frac{f_{up}^{'} +f_{down}^{'} }{2}  \quad,\quad  \delta s^{'}=\frac{f_{up}^{'} -f_{down}^{'} }{2gcos\theta}-1
$$

可见当倾角 $\theta$ 较小时，对加速度计的零偏和比例因子的影响较小，两位置法标定对倾角具有鲁棒性。

同理，对于加速度计的其他两个轴向都可以采用上面方法来得到它们的零偏和比例因子。

### 加速度计六位置法标定

加速度计的测量模型可写作如下矩阵形式，其中 $\tilde f_x$ , $\tilde f_y$ , $ \tilde f_z$ 为三轴加速度计实际输出，$\gamma_{xy}$ , $\gamma_{xz}$ , $\gamma_{yx}$ , $\gamma_{yz}$ , $\gamma_{zx}$ , $\gamma_{zy}$ 为交轴耦合误差分量，$s_x$ , $s_y$ , $s_z$ 为比例因子，$f_x$ , $f_y$ , $f_z$ 为理想加速度计输出，$b_{ax}$ , $b_{ay}$ , $b_{az}$ 为加速度计三轴零偏：

$$
\begin{bmatrix}\tilde f_x\\ \tilde f_y\\ \tilde f_z\end{bmatrix}
=
\begin{bmatrix}
s_x & \gamma_{yx} & \gamma_{zx}\\
\gamma_{xy} & s_y & \gamma_{zy}\\
\gamma_{xz} & \gamma_{yz} & s_z
\end{bmatrix}
\begin{bmatrix}
f_x\\
f_y\\
f_z
\end{bmatrix}
+
\begin{bmatrix}
b_{ax}\\
b_{ay}\\
b_{az}
\end{bmatrix}
=
\begin{bmatrix}
s_x & \gamma_{yx} & \gamma_{zx} & b_{ax}\\
\gamma_{xy} & s_y & \gamma_{zy} & b_{ay}\\
\gamma_{xz} & \gamma_{yz} & s_z & b_{az}
\end{bmatrix}
\begin{bmatrix}
f_x\\
f_y\\
f_z\\
1
\end{bmatrix}
$$

令

$$
M = \begin{bmatrix}
s_x & \gamma_{yx} & \gamma_{zx} & b_{ax}\\
\gamma_{xy} & s_y & \gamma_{zy} & b_{ay}\\
\gamma_{xz} & \gamma_{yz} & s_z & b_{az}
\end{bmatrix}
$$

依次让 $x$ , $y$ , $z$ 三轴加速度计敏感轴分别竖直向上和竖直向下静置一段时间，采集六次加速度计的输出取均值，得到：

$$
L=\begin{bmatrix} \tilde f_{xup} & \tilde f_{xdown} & \tilde f_{yup} & \tilde f_{ydown} & \tilde f_{zup} & \tilde f_{zdown} \end{bmatrix}
$$

各位置理想加速度计输出为：

$$
f_{xup}=\begin{bmatrix} g\\ 0\\ 0\end{bmatrix}\quad
f_{xdown}=\begin{bmatrix} -g\\ 0\\ 0\end{bmatrix}\quad
f_{yup}=\begin{bmatrix} 0\\ g\\ 0\end{bmatrix}\quad
f_{ydown}=\begin{bmatrix} 0\\ -g\\ 0\end{bmatrix}\quad
f_{zup}=\begin{bmatrix} 0\\ 0\\ g\end{bmatrix}\quad
f_{zdown}=\begin{bmatrix} 0\\ 0\\ -g\end{bmatrix}
$$

即：

$$
A=\begin{bmatrix} f_{xup} & f_{xdown} & f_{yup} & f_{ydown} & f_{zup} & f_{zdown}\\1 & 1 & 1 & 1 & 1 & 1 \end{bmatrix}
$$

六位置的加速度计输出模型可以写作如下矩阵形式：

$$
\begin{bmatrix} \tilde f_{xup} & \tilde f_{xdown} & \tilde f_{yup} & \tilde f_{ydown} & \tilde f_{zup} & \tilde f_{zdown} \end{bmatrix}=M\begin{bmatrix} f_{xup} & f_{xdown} & f_{yup} & f_{ydown} & f_{zup} & f_{zdown}\\1 & 1 & 1 & 1 & 1 & 1 \end{bmatrix}
$$

$M$矩阵中包含12个待估参数，共有18个方程。可以用最小二乘法求解

$$
M = LA^T(AA^T)^{-1}
$$

