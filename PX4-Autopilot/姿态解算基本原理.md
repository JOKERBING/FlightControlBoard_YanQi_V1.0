# 姿态解算基本原理

## 常用的坐标系

在惯性导航中常用的坐标系有实用惯性坐标系（i-frame）、地心地固坐标系（e-frame）、导航坐标系（n-frame）和载体坐标系（b-frame）。

1、实用惯性坐标系 $O-x_iy_iz_i$

实用惯性坐标系是以牛顿运动定律为基础的坐标系，不受外力影响的静止的坐标系。但世界中一切物体都是运动的，因此根本就不存在静止的惯性坐标系，只能人为地选取所需的惯性坐标系。地心是地球附近唯一不参与地球自转的空间点，因此选取地球中心当做实用惯性坐标系的原点，该坐标系适用于地球附近的物体。$z_i$轴沿地球自转轴方向，由地心指向北极点，$x_i$轴在赤道平面内，由地心指向春分点，$y_i$轴与$x_i$ , $z_i$轴构成右手坐标系。

2、地心地固坐标系 $O-x_ey_ez_e$

地心地固坐标系是惯性导航工作中最常用到的坐标系，是指固联在地球上的坐标系，原点在地球的质心，它相对于惯性坐标系以地球自转角速度旋转。$z_e$轴沿地球自转轴方向，由地心指向北极点，$x_e$轴在赤道平面内，由地心指向格林尼治子午线，$y_e$轴与$x_e$ , $z_e$轴构成右手坐标系。

3、导航坐标系 $O-x_ny_nz_n$

导航坐标系是根据导航过程中载体的工作任务、工作环境、以及载体本身的需求而确定的基准坐标系，俗称东北天坐标系。坐标原点在载体质心或参考点，$z_n$轴沿当地垂线指向天空，$x_n$轴指向正东，$y_n$轴指向正北，$x_n$ , $y_n$ , $z_n$轴构成右手坐标系。

4、载体坐标系 $O-x_by_bz_b$

载体坐标系是以载体的重心处为坐标原点，$x_b$轴平行于载体横切面指向载体右侧，$y_b$轴平行于载体纵切面指向前，$z_b$轴垂直于载体横切面竖直向上，$x_b$ , $y_b$ , $z_b$轴构成右手坐标系。通常利用载体坐标系相对导航坐标系的坐标变换矩阵求取载体的姿态角和航向角。

<div align=center><img src="https://jokerbin.oss-cn-beijing.aliyuncs.com/202209041343180.png" width="1000"/></div>

## 姿态角

姿态角包括横滚角(roll)、俯仰角(pitch)和航向角(yaw)，姿态角也称欧拉角，它是描述载体姿态最直观的方式。本文对载体姿态角做出如下规定：首先坐标系绕着某一坐标轴旋转时遵循右手螺旋定则，即大拇指指向旋转轴的正向，规定向四指弯曲指向的方向旋转取值为正，相对于观察者来说，当某一坐标旋转轴指向观察者时，规定向逆时针方向旋转为正。将Z轴保持不动，X轴和Y轴绕Z轴转动得到航向角(水平面内与Y轴夹角)且航向角逆时针旋转从0º到+360º依次增加；将X轴保持不动，Y轴和Z轴绕X轴转动得到俯仰角，按逆时针旋转，最大旋转到+90º，顺时针最大旋转到-90º，即俯仰角范围是-90º 到+90º；将Y轴保持不动，X轴和Z轴绕Y轴转动得到横滚角，逆时针旋转即0º到+180º依次增加，顺时针旋转从0º到-180º依次减小，且+180º与-180º重合，即横滚角范围是-180º到+180º。 

<div align=center><img src="https://jokerbin.oss-cn-beijing.aliyuncs.com/202209041343884.png" width="500"/></div>

## 坐标系变换

不同坐标系间都存在一定的位置关系，这种关系可用变换矩阵表示。对于导航坐标系向载体坐标系的变换，设导航坐标系$O-x_ny_nz_n$绕$Oz_n$轴旋转$\psi$角后得到坐标系$O-x_1y_1z_1$，坐标系$O-x_1y_1z_1$绕$Oy_1$轴旋转$\theta$角后得到坐标系$O-x_2y_2z_2$，坐标系$O-x_2y_2z_2$绕$Ox_2$轴旋转$\phi$角后得到载体坐标系$O-x_by_bz_b$，经过三次绕轴旋转可以完成坐标系的变换。

<div align=center><img src="https://jokerbin.oss-cn-beijing.aliyuncs.com/202209041343723.png" width="800"/></div>


对于坐标系$O-x_ny_nz_n$中坐标为$\begin{bmatrix} \alpha_n & \beta_n & \gamma_n \end{bmatrix}^T$的某点，其在坐标系$O-x_1y_1z_1$中的坐标为$\begin{bmatrix} \alpha_1 & \beta_1 & \gamma_1 \end{bmatrix}^T$，在坐标系$O-x_2y_2z_2$中的坐标为$\begin{bmatrix} \alpha_2 & \beta_2 & \gamma_2 \end{bmatrix}^T$，在坐标系$O-x_by_bz_b$中的坐标为$\begin{bmatrix} \alpha_b & \beta_b & \gamma_b \end{bmatrix}^T$，有对应关系：

$$
\begin{bmatrix} \alpha_1 \\ \beta_1 \\ \gamma_1 \end{bmatrix}
=
R_n^1
\begin{bmatrix} \alpha_n \\ \beta_n \\ \gamma_n \end{bmatrix}
=
\begin{bmatrix}
cos\psi & sin\psi & 0\\
-sin\psi & cos\psi & 0\\
0 & 0 & 1
\end{bmatrix}
\begin{bmatrix} \alpha_n \\ \beta_n \\ \gamma_n \end{bmatrix}
$$

$$
\begin{bmatrix} \alpha_2 \\ \beta_2 \\ \gamma_2 \end{bmatrix}
=
R_1^2
\begin{bmatrix} \alpha_1 \\ \beta_1 \\ \gamma_1 \end{bmatrix}
=
\begin{bmatrix}
cos\theta & 0 & -sin\theta\\
0 & 1 & 0\\
sin\theta & 0 & cos\theta
\end{bmatrix}
\begin{bmatrix} \alpha_1 \\ \beta_1 \\ \gamma_1 \end{bmatrix}
$$

$$
\begin{bmatrix} \alpha_b \\ \beta_b \\ \gamma_b \end{bmatrix}
=
R_2^b
\begin{bmatrix} \alpha_2 \\ \beta_2 \\ \gamma_2 \end{bmatrix}
=
\begin{bmatrix}
1 & 0 & 0\\
0 & cos\phi & sin\phi\\
0 & -sin\phi & cos\phi
\end{bmatrix}
\begin{bmatrix} \alpha_2 \\ \beta_2 \\ \gamma_2 \end{bmatrix}
$$

以上三个基本变换矩阵依次合并后可得由地心地固坐标系向载体坐标系的变换矩阵：
$$
\begin{aligned}
R_n^b
&=
R_2^b
R_1^2
R_n^1\\
&=
\begin{bmatrix}
1 & 0 & 0\\
0 & cos\phi & sin\phi\\
0 & -sin\phi & cos\phi
\end{bmatrix}
\begin{bmatrix}
cos\theta & 0 & -sin\theta\\
0 & 1 & 0\\
sin\theta & 0 & cos\theta
\end{bmatrix}
\begin{bmatrix}
cos\psi & sin\psi & 0\\
-sin\psi & cos\psi & 0\\
0 & 0 & 1
\end{bmatrix}\\
&=
\begin{bmatrix}
cos\theta cos\psi & cos\theta sin\psi & -sin\theta\\
sin\phi sin\theta cos\psi-cos\phi sin\psi & sin\phi sin\theta sin\psi+cos\phi cos\psi & sin\phi cos\theta\\
cos\phi sin\theta cos\psi+sin\phi sin\psi & cos\phi sin\theta sin\psi-sin\phi cos\psi & cos\phi cos\theta
\end{bmatrix}
\end{aligned}
$$
则有：
$$
\begin{bmatrix} \alpha_b \\ \beta_b \\ \gamma_b \end{bmatrix}
=
R_n^b
\begin{bmatrix} \alpha_n \\ \beta_n \\ \gamma_n \end{bmatrix}
$$
如果由地心地固坐标系向载体坐标系的旋转过程中各坐标系都保持为直角坐标系，则根据正交矩阵的性质有：
$$
\begin{aligned}
	R_{b}^{n}&=(R_{n}^{b})^T\\
	&=\left[ \begin{matrix}
	cos\theta cos\psi&		sin\phi sin\theta cos\psi -cos\phi sin\psi&		cos\phi sin\theta cos\psi +sin\phi sin\psi\\
	cos\theta sin\psi&		sin\phi sin\theta sin\psi +cos\phi cos\psi&		cos\phi sin\theta sin\psi -sin\phi cos\psi\\
	-sin\theta&		sin\phi cos\theta&		cos\phi cos\theta\\
\end{matrix} \right]\\
\end{aligned}
$$
同理有：
$$
\begin{bmatrix} \alpha_n \\ \beta_n \\ \gamma_n \end{bmatrix}
=
R_b^n
\begin{bmatrix} \alpha_b \\ \beta_b \\ \gamma_b \end{bmatrix}
$$

## 姿态角的确定

如果已知由导航坐标系向载体坐标系的变换矩阵，则可求出载体的姿态角。将变换矩阵$R_n^b$中的每一个元素用带有下标的字母$r_{ij}$表示，$r_{ij}$表示矩阵中第$i$行，第$j$列的元素。
$$
R_n^b
=
\begin{bmatrix}
r_{11} & r_{12} & r_{13}\\
r_{21} & r_{22} & r_{23}\\
r_{31} & r_{32} & r_{33}
\end{bmatrix}
$$
则可以根据变换矩阵的姿态角表达形式求出姿态角：
$$
\begin{cases}
\psi=arctan\Big(\displaystyle\frac{r_{12}}{r_{11}}\Big)\\
\\
\theta=-arcsin(r_{13})\\
\\
\phi=arctan\Big(\displaystyle\frac{r_{23}}{r_{33}}\Big)
\end{cases}
$$

## 姿态解算基本方法

陀螺仪测量绕三个轴转动的角速度，因此利用陀螺仪的输出值进行一段时间的积分可以得到一组姿态角。但是这组角度值为陀螺仪自身坐标系下的角度值，若要求得导航坐标系下的姿态角，一般利用陀螺信号通过与欧拉角、方向余弦矩阵或四元数进行微分的方法进行姿态信息的更新。

### 欧拉角法

假设陀螺仪在第n个时刻的航向角为$\phi$，横滚角为$\theta$，俯仰角为$\psi$，其含义为陀螺仪从初始位置，经过绕$z$轴旋转$\phi$角度，绕$y$轴旋转$\theta$角度，绕$x$轴旋转$\psi$角度，得到了n时刻的姿态，此时需要计算n+1时刻的姿态。设n+1时刻的航向角为$\phi+\Delta\phi$，横滚角为$\theta+\Delta\theta$，俯仰角为$\psi+\Delta\psi$，该姿态也是n时刻经过了三次旋转得到的，要想计算n+1时刻的姿态，只要在n时刻姿态的基础上，加上对应的姿态角度变化量即可，姿态角度的变化量可以通过角速度与采用时间周期积分即可。
$$
\begin{cases}
\psi(n+1)=\psi(n)+\Delta\psi=\psi(n)+\Big(\displaystyle\frac{d\psi}{dt}\Big)\Delta t\\
\\
\theta(n+1)=\theta(n)+\Delta\theta=\theta(n)+\Big(\displaystyle\frac{d\theta}{dt}\Big)\Delta t\\
\\
\phi(n+1)=\phi(n)+\Delta\phi=\phi(n)+\Big(\displaystyle\frac{d\phi}{dt}\Big)\Delta t\\
\end{cases}
$$
从n时刻到n+1时刻需要经过三次绕轴旋转，三次绕轴旋转的角速度分别为$\displaystyle\frac{d\psi}{dt},\displaystyle\frac{d\theta}{dt},\displaystyle\frac{d\phi}{dt}$，姿态角是以导航坐标系为参考，而陀螺仪读出的角速度$\begin{bmatrix} g_x & g_y & g_z \end{bmatrix}^T$是以载体坐标系为参考，因此需要将读到的数据经过变换，才能用于计算姿态的变化。

绕$z$轴旋转的角速度为$\displaystyle\frac{d\phi}{dt}$，三次旋转首先就是绕着$z$轴旋转，$\begin{bmatrix} 0 & 0 & \displaystyle\frac{d\phi}{dt} \end{bmatrix}^T$表示第一步绕$z$轴转动的角速度，由于之后该坐标系还要经过绕$y$轴和绕$x$轴的两次旋转，因此$\begin{bmatrix} 0 & 0 & \displaystyle\frac{d\phi}{dt} \end{bmatrix}^T$经历两次旋转后也要经历两次变换，$M_x,M_y$表示绕$x,y$轴的旋转矩阵，$\begin{bmatrix} g_x & g_y & g_z \end{bmatrix}_z^T$表示绕$z$轴的旋转角速度在两次旋转后的等效旋转角速度。
$$
\begin{bmatrix} g_x \\ g_y \\ g_z \end{bmatrix}_z
=
M_x
M_y
\begin{bmatrix} 0 \\ 0 \\ \displaystyle\frac{d\phi}{dt} \end{bmatrix}
=
\begin{bmatrix}
1 & 0 & 0\\
0 & cos\psi & sin\psi\\
0 & -sin\psi & cos\psi
\end{bmatrix}
\begin{bmatrix}
cos\theta & 0 & -sin\theta\\
0 & 1 & 0\\
sin\theta & 0 & cos\theta
\end{bmatrix}
\begin{bmatrix} 0 \\ 0 \\ \displaystyle\frac{d\phi}{dt} \end{bmatrix}
$$
同理，绕$y$轴旋转的角速度$\begin{bmatrix} 0 & \displaystyle\frac{d\theta}{dt} & 0 \end{bmatrix}^T$还要经过绕$x$轴的旋转，$M_x$表示绕$x$轴的旋转矩阵，$\begin{bmatrix} g_x & g_y & g_z \end{bmatrix}_y^T$表示绕$y$轴的旋转角速度在一次旋转后的等效旋转角速度。
$$
\begin{bmatrix} g_x \\ g_y \\ g_z \end{bmatrix}_y
=
M_x
\begin{bmatrix} 0 \\ \displaystyle\frac{d\theta}{dt} \\ 0 \end{bmatrix}
=
\begin{bmatrix}
1 & 0 & 0\\
0 & cos\psi & sin\psi\\
0 & -sin\psi & cos\psi
\end{bmatrix}
\begin{bmatrix} 0 \\ \displaystyle\frac{d\theta}{dt} \\ 0 \end{bmatrix}
$$
同理，绕$x$轴旋转的角速度$\begin{bmatrix} \displaystyle\frac{d\psi}{dt} & 0 & 0 \end{bmatrix}^T$不需要经过旋转，$\begin{bmatrix} g_x & g_y & g_z \end{bmatrix}_x^T$表示绕$x$轴的旋转角速度的等效旋转角速度。
$$
\begin{bmatrix} g_x \\ g_y \\ g_z \end{bmatrix}_x
=
\begin{bmatrix} \displaystyle\frac{d\psi}{dt} \\ 0 \\ 0 \end{bmatrix}
$$
将绕三轴旋转的角速度经过旋转变换的等效旋转角速度进行相加，即是n+1时刻陀螺仪读出的角速度$\begin{bmatrix} g_x & g_y & g_z \end{bmatrix}^T$。
$$
\begin{aligned}
\begin{bmatrix} g_x \\ g_y \\ g_z \end{bmatrix}
&=
\begin{bmatrix}
1 & 0 & 0\\
0 & cos\psi & sin\psi\\
0 & -sin\psi & cos\psi
\end{bmatrix}
\begin{bmatrix}
cos\theta & 0 & -sin\theta\\
0 & 1 & 0\\
sin\theta & 0 & cos\theta
\end{bmatrix}
\begin{bmatrix} 0 \\ 0 \\ \displaystyle\frac{d\phi}{dt} \end{bmatrix}
+
\begin{bmatrix}
1 & 0 & 0\\
0 & cos\psi & sin\psi\\
0 & -sin\psi & cos\psi
\end{bmatrix}
\begin{bmatrix} 0 \\ \displaystyle\frac{d\theta}{dt} \\ 0 \end{bmatrix}
+
\begin{bmatrix} \displaystyle\frac{d\psi}{dt} \\ 0 \\ 0 \end{bmatrix}\\
&=
\begin{bmatrix}
1 & 0 & -sin\theta\\
0 & cos\psi & cos\theta sin\psi\\
0 & -sin\psi & cos\theta cos\psi
\end{bmatrix}
\begin{bmatrix} \displaystyle\frac{d\psi}{dt} \\ \displaystyle\frac{d\theta}{dt} \\ \displaystyle\frac{d\phi}{dt} \end{bmatrix}
\end{aligned}
$$
对矩阵求逆，得：
$$
\begin{bmatrix} \displaystyle\frac{d\psi}{dt} \\ \displaystyle\frac{d\theta}{dt} \\ \displaystyle\frac{d\phi}{dt} \end{bmatrix}
=
\frac{1}{cos\theta}
\begin{bmatrix}
cos\theta & sin\theta sin\psi & sin\theta cos\psi\\
0 & cos\theta cos\psi & -cos\theta sin\psi\\
0 & sin\psi & cos\psi
\end{bmatrix}
\begin{bmatrix} g_x \\ g_y \\ g_z \end{bmatrix}
$$
由上式即可用n+1时刻陀螺仪读出的角速度$\begin{bmatrix} g_x & g_y & g_z \end{bmatrix}^T$求出姿态角的旋转角速度，已知n时刻的姿态角，即可求出n+1时刻的姿态角。

这种使用直接使用欧拉角来更新姿态的方法物理意义直观明显，但是由于需要计算较多的三角函数，因此计算量较大，而且当俯仰角接近±90°时，矩阵中的$cos\theta$会等于0，这会导致出现奇异性问题，即万向节死锁现象。

### 方向余弦法

设$r_n$是导航坐标系中的矢径，$r_b$是载体坐标系中的矢径，$\omega_n$是以导航坐标系为参考的载体坐标系旋转的角速度矩阵，由科氏定理有：
$$
\frac{dr_n}{dt}=\frac{dr_b}{dt}+\omega_n\times r_n
$$
在载体坐标系内，矢径$r_b$的大小和方向是固定不变的，因此：
$$
\frac{dr_b}{dt}=0
$$
从而有：
$$
\frac{dr_n}{dt}=\omega_n\times r_n
$$
陀螺仪测得的角速度是以载体坐标系为参考的旋转角速度矩阵$\omega_b=\begin{bmatrix}\omega_x & \omega_y & \omega_z\end{bmatrix}^T$，所以将等式两边都变换到载体坐标系中，即：
$$
\frac{d(R_b^n r_b)}{dt}=R_b^n(\omega_b \times r_b)
$$
$$
\frac{dR_b^n}{dt}r_b+R_b^n\frac{dr_b}{dt}=R_b^n(\omega_b \times) r_b
$$
将$\displaystyle\frac{dr_b}{dt}=0$代入，$(\omega_b \times)$为旋转角速度矩阵的反对称矩阵，记作$\Omega_b$，有：
$$
\frac{dR_b^n}{dt}r_b=R_b^n \Omega_b r_b
$$
最终得到旋转矩阵变化率与载体旋转角速率之间的关系：
$$
\frac{dR_b^n}{dt}=R_b^n \Omega_b
$$
式中：
$$
\Omega_b=(\omega_b \times)=
\begin{bmatrix}
0 & -\omega_z & \omega_y\\
\omega_z & 0 & -\omega_x\\
-\omega_y & \omega_x & 0
\end{bmatrix}
$$
对这个时变系数齐次微分方程可以利用毕卡逼近法求解，可得：
$$
R_b^n(t)=R_b^n(0)+\int_0^t R_b^n(\tau) \Omega_b(\tau) d\tau
$$
$$
R_b^n(t)=R_b^n(0)\bigg[ 
I+\int_0^t \Omega_b(\tau) d\tau
+\int_0^t\int_0^\tau \Omega_b(\tau_1)d\tau_1 \Omega_b(\tau) d\tau
+\int_0^t\int_0^\tau\int_0^{\tau_1} \Omega_b(\tau_2)d\tau_2 \Omega_b(\tau_1)d\tau_1 \Omega_b(\tau) d\tau
+\cdots
\bigg]
$$
级数收敛，若积分时段内$\omega_b$的方向保持不变可得闭合解：
$$
R_b^n(t)=R_b^n(0)exp\left(\int_0^t \Omega_b(\tau) d\tau\right)
$$
进一步进行泰勒展开，得：
$$
\begin{aligned}
exp(\Delta \theta \times)&=
I+(\Delta \theta \times)+\frac{(\Delta \theta \times)^2}{2!}+\frac{(\Delta \theta \times)^3}{3!}+\cdots\\
&=I+\bigg[1-\frac{\Delta \theta ^2}{3!}+\frac{\Delta \theta ^4}{5!}-\cdots\bigg](\Delta \theta \times)+\bigg[\frac{1}{2}-\frac{\Delta \theta ^2}{4!}+\frac{\Delta \theta ^4}{6!}-\cdots\bigg](\Delta \theta \times)^2\\
&=I+\frac{sin\Delta \theta}{\Delta \theta}(\Delta \theta \times)+\frac{1-cos\Delta \theta}{\Delta \theta^2}(\Delta \theta \times)^2
\end{aligned}
$$
若等式$\displaystyle(\Delta \theta _0\times)=\int_{t}^{t+\Delta t} \Omega_b(\tau) d\tau$成立，则微分方程的精确解为：
$$
R_b^n(t+\Delta t)=R_b^n(t)\bigg[I+\frac{sin\Delta \theta_0}{\Delta \theta_0} (\Delta \theta_0 \times)+\frac{1-cos\Delta \theta_0}{\Delta \theta_0^2} (\Delta \theta_0 \times)^2\bigg]
$$
式中：
$$
[\Delta \theta_0 \times]=
\begin{bmatrix}
0 & -\Delta \theta_z & \Delta \theta_y\\
\Delta \theta_z & 0 & -\Delta \theta_x\\
-\Delta \theta_y & \Delta \theta_x & 0
\end{bmatrix}\\
\Delta \theta_0^2=(\Delta \theta_x)^2+(\Delta \theta_y)^2+(\Delta \theta_z)^2
$$
运用方向余弦法进行姿态解算，避免了欧拉角法中的万向节死锁问题，可全姿态工作。但是解算矩阵微分方程时实质上是解算九个线性微分方程，计算量大，实时计算困难，所以工程上并不实用。

### 四元数法

四元数$Q$的定义为：
$$
Q=q_0+q_1\vec i+q_2\vec j+q_3\vec k
$$
式中$q_0,q_1,q_2,q_3$是实数，$\vec i,\vec j,\vec k$是相互正交的单位向量。

定义四元数的范数和模分别为：
$$
\parallel Q\parallel=q_0^2+q_1^2+q_2^2+q_3^2\\
|Q|=\sqrt{q_0^2+q_1^2+q_2^2+q_3^2}
$$
若$\parallel Q\parallel=1$，则称$Q$为规范化四元数。

设$P=p_0+p_1\vec i+p_2\vec j+p_3\vec k$，则两个四元数相乘的表达式为：
$$
P\otimes Q=r_0+r_1\vec i+r_2\vec j+r_3\vec k
$$
将上式写成矩阵形式，有:
$$
\begin{bmatrix}
r_0\\
r_1\\
r_2\\
r_3
\end{bmatrix}
=
\begin{bmatrix}
p_0 & -p_1 & -p_2 & -p_3\\
p_1 & p_0 & -p_3 & p_2\\
p_2 & p_3 & p_0 & -p_1\\
p_3 & -p_2 & p_1 & p_0
\end{bmatrix}
\begin{bmatrix}
q_0\\
q_1\\
q_2\\
q_3
\end{bmatrix}
$$
四元数乘法满足分配率和结合律，不满足交换律。

四元数本身在物理意义上代表一个转动，又可以看成一个算子。一个坐标系相对另一个坐标系的相对转动可以用四元数唯一地表示出来，用四元数来描述载体坐标系相对导航坐标系的转动时，可得姿态矩阵的四元数表达式为：
$$
R_b^n=
\begin{bmatrix}
q_0^2+q_1^2-q_2^2-q_3^2 & 2(q_1q_2-q_0q_3) & 2(q_1q_3+q_0q_2)\\
2(q_1q_2+q_0q_3) & q_0^2-q_1^2+q_2^2-q_3^2 & 2(q_2q_3-q_0q_1)\\
2(q_1q_3-q_0q_2) & 2(q_2q_3+q_0q_1) & q_0^2-q_1^2-q_2^2+q_3^2
\end{bmatrix}
$$
可得出四元数与欧拉角的关系为：
$$
\begin{cases}
\phi=arctan\displaystyle\frac{2(q_2q_3+q_0q_1)}{q_0^2-q_1^2-q_2^2+q_3^2}\\
\\
\theta=-arcsin[2(q_1q_3-q_0q_2)]\\
\\
\psi=arctan\displaystyle\frac{2(q_1q_2+q_0q_3)}{q_0^2+q_1^2-q_2^2-q_3^2}\\
\end{cases}
$$

$$
\begin{cases}
\displaystyle q_0=cos\frac{\phi}{2}cos\frac{\theta}{2}cos\frac{\psi}{2}+sin\frac{\phi}{2}sin\frac{\theta}{2}sin\frac{\psi}{2}\\
\\
\displaystyle q_1=sin\frac{\phi}{2}cos\frac{\theta}{2}cos\frac{\psi}{2}-cos\frac{\phi}{2}sin\frac{\theta}{2}sin\frac{\psi}{2}\\
\\
\displaystyle q_2=cos\frac{\phi}{2}sin\frac{\theta}{2}cos\frac{\psi}{2}+sin\frac{\phi}{2}cos\frac{\theta}{2}sin\frac{\psi}{2}\\
\\
\displaystyle q_3=cos\frac{\phi}{2}cos\frac{\theta}{2}sin\frac{\psi}{2}+sin\frac{\phi}{2}sin\frac{\theta}{2}cos\frac{\psi}{2}\\
\end{cases}
$$

四元数的微分方程为：
$$
\dot Q=\frac{1}{2}Q\otimes\omega_b=\frac{1}{2}M(\omega_b)Q
$$
式中：
$$
M(\omega_b)=
\begin{bmatrix}
0 & -\omega_x & -\omega_y & -\omega_z\\
\omega_x & 0 & \omega_z & -\omega_y\\
\omega_y & -\omega_z & 0 & \omega_x\\
\omega_z & \omega_y & -\omega_x & 0
\end{bmatrix}
$$
把四元数微分方程展开成矩阵形式，得：
$$
\begin{bmatrix}
\dot q_0\\
\dot q_1\\
\dot q_2\\
\dot q_3
\end{bmatrix}
=
\frac{1}{2}
\begin{bmatrix}
0 & -\omega_x & -\omega_y & -\omega_z\\
\omega_x & 0 & \omega_z & -\omega_y\\
\omega_y & -\omega_z & 0 & \omega_x\\
\omega_z & \omega_y & -\omega_x & 0
\end{bmatrix}
\begin{bmatrix}
q_0\\
q_1\\
q_2\\
q_3
\end{bmatrix}
$$
由上式可求得姿态四元数$Q$，将其代入姿态矩阵解析式可求姿态矩阵$R_b^n$，进而求得姿态角。

对于一阶常微分方程$\begin{cases}y^{'}=f(x,y)\\y(x_0)=y_0\end{cases}$，采用四阶龙格-库塔法求解，其数值解表达式为：
$$
\begin{cases}
\displaystyle y_{n+1}=y_n+\frac{h}{6}(K_1+2K_2+2K_3+K_4)\\
K_1=f(x_n,y_n)\\
\displaystyle K_2=f(x_n+\frac{h}{2},y_n+\frac{h}{2}K_1)\\
\displaystyle K_3=f(x_n+\frac{h}{2},y_n+\frac{h}{2}K_2)\\
\displaystyle K_4=f(x_n+h,y_n+hK_3)
\end{cases}
$$
对于四元数微分方程，应用上述公式，得到数值解表达式为：
$$
\begin{cases}
\displaystyle Q(t_{n+1})=Q(t_n)+\frac{h}{6}(K_1+2K_2+2K_3+K_4)\\
\displaystyle K_1=\frac{1}{2}M[\omega_b(t_n)]Q(t_n)\\
\displaystyle K_2=\frac{1}{2}M[\omega_b(t_n+\frac{h}{2})][Q(t_n)+\frac{K_1}{2}h]\\
\displaystyle K_3=\frac{1}{2}M[\omega_b(t_n+\frac{h}{2})][Q(t_n)+\frac{K_2}{2}h]\\
\displaystyle K_4=\frac{1}{2}M[\omega_b(t_n+h)][Q(t_n)+K_3h]
\end{cases}
$$
式中：
$$
h=t_{n+1}-t_n
$$
四元数的初值由惯导的初始对准确定。
$$
\begin{cases}
R_b^n=
\begin{bmatrix}
q_0^2+q_1^2-q_2^2-q_3^2 & 2(q_1q_2-q_0q_3) & 2(q_1q_3+q_0q_2)\\
2(q_1q_2+q_0q_3) & q_0^2-q_1^2+q_2^2-q_3^2 & 2(q_2q_3-q_0q_1)\\
2(q_1q_3-q_0q_2) & 2(q_2q_3+q_0q_1) & q_0^2-q_1^2-q_2^2+q_3^2
\end{bmatrix}
=
\begin{bmatrix}
r_{11} & r_{12} & r_{13}\\
r_{21} & r_{22} & r_{23}\\
r_{31} & r_{32} & r_{33}
\end{bmatrix}
\\
q_0^2+q_1^2+q_2^2+q_3^2=1
\end{cases}
$$
可得四元数初值$q_0,q_1,q_2,q_3$的大小为：
$$
\begin{cases}
\displaystyle |q_0|=\frac{1}{2}\sqrt{1+r_{11}+r_{22}+r_{33}}\\
\displaystyle |q_1|=\frac{1}{2}\sqrt{1+r_{11}-r_{22}-r_{33}}\\
\displaystyle |q_2|=\frac{1}{2}\sqrt{1-r_{11}+r_{22}-r_{33}}\\
\displaystyle |q_3|=\frac{1}{2}\sqrt{1-r_{11}-r_{22}+r_{33}}\\
\end{cases}
$$
根据$\begin{cases}4q_0q_1=r_{32}-r_{23}\\4q_0q_2=r_{13}-r_{31}\\4q_0q_3=r_{21}-r_{12}\end{cases}$，$q_0,q_1,q_2,q_3$的符号可由下式确定：
$$
\begin{cases}
	sign(q_1)=sign(q_0)sign(r_{32}-r_{23})\\
	sign(q_2)=sign(q_0)sign(r_{13}-r_{31})\\
	sign(q_3)=sign(q_0)sign(r_{21}-r_{12})\\
\end{cases}
$$
描述刚体旋转的四元数为规范化四元数，但由于计算误差等各种因素的影响，计算过程中四元数会逐渐失去规范化特征，所以需要对四元数进行规范化处理。
$$
q_i=\frac{\hat q_i}{\sqrt{\hat q_0^2+\hat q_1^2+\hat q_2^2+\hat q_3^2}}
$$
式中：$i=0,1,2,3$，$\hat q_0,\hat q_1,\hat q_2,\hat q_3$是四元数更新所得的值。

四元数法只需求解四个未知量的线性微分方程组，在进行数值积分时只需要进行加减法和乘法运算，计算量比欧拉角法和方向余弦法都小，且算法简单，易于操作，是较实用的工程方法。但四元数法对有限转动引起的不可交换误差的补偿程度不够,所以只适用于低动态运载体如运输机等的姿态解算；而对高动态运载体，姿态解算时的算法漂移会十分严重。
